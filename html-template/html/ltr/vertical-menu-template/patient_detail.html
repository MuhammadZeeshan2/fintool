{% extends 'base.html' %}
{% load static %}

{% block content %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <style>
        .select2-container{
            width: 100% !important;
        }
    </style>
    <!-- BEGIN: Content-->
        <div class="content-overlay"></div>
        <div class="header-navbar-shadow"></div>
        <div class="content-wrapper">
            <div class="content-header row">
                <div class="content-header-left col-md-9 col-12 mb-2">
                    <div class="row breadcrumbs-top">
                        <div class="col-12">
                            <h2 class="content-header-title float-left mb-0">Subject</h2>
                            <div class="breadcrumb-wrapper col-12">
                                <ol class="breadcrumb">
                                    <li class="breadcrumb-item"><a href="{% url 'home' %}">Dashboard</a>
                                    </li>
                                    <li class="breadcrumb-item">Subjects</a>
                                    </li>
                                    <li class="breadcrumb-item active">{{patient.mrm}}
                                    </li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="content-body">
                {% include 'alert.html' %}
                <section class="page-users-view">
                    <div class="row">
                        <!-- account start -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">Information</div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-12 col-sm-9 col-md-6 col-lg-5">
                                            <table>
                                                <tr>
                                                    <td class="font-weight-bold">Gender</td>
                                                    <td>{{patient.gender}}</td>
                                                </tr>
                                                <tr>
                                                    <td class="font-weight-bold">Research ID</td>
                                                    <td>{{patient.mrm}}</td>
                                                </tr>
                                                <tr>
                                                    <td class="font-weight-bold">Date of Birth</td>
                                                    {% if patient.dob %}
                                                        <td>{{ patient.dob|date:"M. d, Y" }}</td>
                                                    {% else %}
                                                        <td>Not Available</td>
                                                    {%endif%}
                                                </tr>
                                            </table>
                                        </div>
                                        <div class="col-12 col-md-12 col-lg-5">
                                            <table class="ml-0 ml-sm-0 ml-lg-0">
                                                <tr>
                                                    <td class="font-weight-bold">State</td>
                                                    <td>{{patient.state}}</td>
                                                </tr>
                                                <tr>
                                                    <td class="font-weight-bold">Health Facility</td>
                                                    <td>{{patient.hospital}}</td>
                                                </tr>
                                            </table>
                                        </div>
                                        <div class="col-12">
                                            {% if 'medical_research.change_patient' in user.get_all_permissions %}
                                                <button type="button" class="btn btn-primary mr-1 mb-1" data-toggle="modal" data-target="#EditModel">
                                                    Edit
                                                </button>
                                            {% endif %}
                                            {% if 'medical_research.delete_patient' in user.get_all_permissions %}
                                                <a href="#" class="btn btn-outline-danger mr-1 mb-1" onclick='return confirmDelete("{% url 'patient-delete' patient.id %}");'><i class="feather icon-trash-2"></i>Delete</a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- account end -->
                    </div>
                </section>
                <!-- Zero configuration table -->
                <div class="modal fade" id="EditModel" tabindex="-1" role="dialog" aria-labelledby="EditModelTitle" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-dialog-centered modal-dialog-scrollable" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="EditModelTitle">Edit Subject</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form class="post-form form form-horizontal" method="POST" action="{% url 'subject-update' patient.id %}"> 
                                    {% csrf_token %}  
                                    <div class="form-body">
                                        <div class="row">
                                            <div class="col-12" hidden>
                                                <div class="form-group row">
                                                    <div class="col-md-4">
                                                        <span>Full Name</span>
                                                    </div>
                                                    <div class="col-md-8">
                                                        <input value="{{patient.name|default_if_none:""}}" type="text" id="name" class="form-control" name="name" placeholder="Full Name" data-validation-required-message="This name field is required">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="form-group row">
                                                    <div class="col-md-4">
                                                        <span>Research ID</span>
                                                    </div>
                                                    <div class="col-md-8">
                                                        <input value="{{patient.mrm|default_if_none:""}}" type="text" id="mrm" class="form-control" name="mrm" placeholder="Research ID" onkeyup="this.value = this.value.toUpperCase();" maxlength="12" required data-validation-required-message="This name field is required">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="form-group row">
                                                    <div class="col-md-4">
                                                        <span>Date of Birth</span>
                                                    </div>
                                                    <div class="col-md-8">
                                                        <input value="{{patient.dob|date:'Y-m-d'|default_if_none:''}}" type='date' class="form-control" id="dob" name="dob" placeholder="Pick Date of Birth">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="form-group row">
                                                    <div class="col-md-4">
                                                        <span>Sex</span>
                                                    </div>
                                                    <div class="col-md-8">
                                                        <select class="select2 form-control" name="gender" required>
                                                            <option value="M"
                                                                {% if patient.gender == "M" %} selected="selected" {% endif %}>Male
                                                            </option>
                                                            <option value="F"
                                                                {% if patient.gender == "F" %} selected="selected" {% endif %}>Female
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="form-group row">
                                                    <div class="col-md-4">
                                                        <span>State</span>
                                                    </div>
                                                    <div class="col-md-8">
                                                        <select class="select2 form-control" id = "state" name="state" required>
                                                            {% for state in states %}
                                                                <option value="{{state.name}}"
                                                                    {% if patient.state == state.name %} selected=selected {% endif %}>{{state.name}}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="form-group row">
                                                    <div class="col-md-4">
                                                        <span>Health Facility</span>
                                                    </div>
                                                    <div class="col-md-8">
                                                        <select class="select2 form-control" id="hospital" name="hospital" required>
                                                            {% for hospital in hospitals %}
                                                                <option value="{{hospital.name}}"
                                                                    {% if patient.hospital == hospital.name %} selected=selected {% endif %}>{{hospital.name}}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-8 offset-md-4">
                                                <button type="submit" class="btn btn-primary mr-1 mb-1">Submit</button>
                                                <button type="reset" class="btn btn-outline-warning mr-1 mb-1">Reset</button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <!-- <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-dismiss="modal">Accept</button>
                            </div> -->
                        </div>
                    </div>
                </div>
                {% if 'medical_research.add_image' in user.get_all_permissions %}
                    <section>
                        <div class="card">
                            <div class="card-header" style="padding: 10px;">
                                <h5 class="card-title">
                                    <a class="collapsed d-block text-dark" data-toggle="collapse" href="#collapse-collapsed" aria-expanded="true" aria-controls="collapse-collapsed" id="heading-collapsed">
                                        <i class="fa fa-chevron-down pull-right"></i>
                                        Upload Images
                                    </a>
                                </h5>
                            </div>
                            <div id="collapse-collapsed" class="collapse" aria-labelledby="heading-collapsed">
                                <div class="card-body">
                                    <div class="row">
                                        <form class="post-form form form-horizontal" enctype="multipart/form-data" onsubmit="onFormSubmit(event);">
                                            {% csrf_token %}
                                            <div class="form-body">
                                                <div class="row">
                                                    <div class="col-12">
                                                        <input type="hidden" name="record_id" id="record_id" value="{{ record.id }}">
                                                        <div class="form-group row">
                                                            <div class="col-md-4">
                                                                <span>Modality</span>
                                                            </div>
                                                            <div class="col-md-8">
                                                                <select class="form-control" name="modality" id="modality" required>
                                                                    {% for modality in modalities %}
                                                                        <option value="{{modality.id}}">{{modality.name}}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <input type="hidden" name="record_id" id="record_id" value="{{ record.id }}">
                                                        <div class="form-group row">
                                                            <div class="col-md-4">
                                                                <span>Anatomy</span>
                                                            </div>
                                                            <div class="col-md-8">
                                                                <select class="form-control" name="anotomy" id="anotomy" required>
                                                                    {% for anotomy in anotomies %}
                                                                        <option value="{{anotomy.id}}">{{anotomy.name}}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="form-group row">
                                                            <div class="col-md-4">
                                                                <span>Diseases</span>
                                                            </div>
                                                            <div class="col-md-8">
                                                                <select class="select2 form-control" id="diseases" name="diseases" required multiple="multiple">
                                                                    {% for disease in diseases %}
                                                                        <option value="{{disease.id}}">{{disease.name}}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="form-group row">
                                                            <div class="col-md-4">
                                                                <span>Age</span>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <input type="number" name="age" id="age" class="form-control" required>
                                                                <span style="color: red; font-size: xx-small;" id="age-alert"></span>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <select name="age_type" id="age_type" class="form-control">
                                                                    <option value="Y">Year</option>
                                                                    <option value="M">Month</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <fieldset class="form-group row">
                                                            <div class="col-md-4">
                                                                <span>Local Images</span>
                                                            </div>
                                                            <div class="col-md-8">
                                                                <div class="custom-file">
                                                                    <input type="file" name="media_files" class="custom-file-input" id="media_files" multiple="multiple">
                                                                    <label class="custom-file-label" for="media_files">Choose upto 100 files</label>
                                                                </div>
                                                                <p id="no_of_files"></p>
                                                                <p id="warning" style="color:red"></p>
                                                            </div>
                                                        </fieldset>
                                                    </div>
                                                    <div class="col-12">
                                                        <fieldset class="form-group row">
                                                            <div class="col-md-4">
                                                                <span>Remote Images</span>
                                                            </div>
                                                            <div class="col-md-8">
                                                                {% if token %}
                                                                    <a class="btn btn-info" id="authorize_button" onclick="handleAuthClick()">Pick Files</a>
                                                                    <a class="btn btn-warning" href="{{uri}}" id="">Connect to Google Drive</a>
                                                                    <p id="no_of_drive_files">Choose upto 20 files</p>
                                                                    <script>let accessToken = '{{token}}';</script>
                                                                {% else %}
                                                                    <a class="btn btn-info" id="" href="{{uri}}">Connect to Google Drive</a>
                                                                {% endif %}
                                                            </div>
                                                        </fieldset>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="progress progress-bar-primary progress-lg" id="progress_bar_div" style="height: 40px">
                                                            <div id="progress_bar" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0.0" aria-valuemax="100" style="width:0%;"></div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-8 offset-md-4">
                                                        <button type="submit" id="submit_button" class="btn btn-primary mr-1 mb-1">Submit</button>
                                                        <button type="button" disabled id="cancel_button" class="btn btn-outline-danger mr-1 mb-1" onclick="cancelRequest();">Cancel</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                {% endif %}
                <section id="basic-datatable">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="card-title">Images</h4>
                                    <div class="modal-primary mr-1 mb-1 d-inline-block">
                                        <!-- Button trigger modal -->
                                        <button type="button" id="clean_button" disabled onclick="clean_button()" class="btn btn-primary mr-1 mb-1 float-right">
                                            Clean Images
                                        </button>
                                        <button type="button" id="delete_button" disabled onclick="delete_button()" class="btn btn-primary mr-1 mb-1 float-right">
                                            Delete Images
                                        </button>
                                        {% if 'medical_research.download_image' in user.get_all_permissions %}
                                        <button type="button" id="download_button" disabled class="btn btn-primary mr-1 mb-1 float-right" data-toggle="modal" data-target="#DownloadModal">
                                            Download Images
                                        </button>
                                        {% endif %}
                                        <h7 id="selected_count" class="mr-1 mb-1 float-right"style="margin-top: 0.5em;">
                                            0 Selected
                                        </h7>
                                    </div>
                                </div>
                                <div class="card-content">
                                    <div class="card-body card-dashboard">
                                        <div class="table-responsive">
                                            <table class="table zero-configuration">
                                                <thead>
                                                    <tr>
                                                        <th class="no-sort" name="prop_ref_no">
                                                            <input class="checkbox select-row" data-rows-group-id="projects" type="checkbox" id="selec_all" onclick="selectAll(this)"/>
                                                        </th>
                                                        <th>Name</th>
                                                        <th>Anatomy</th>
                                                        <th>Modality</th>
                                                        <th>Clean</th>
                                                        <th>Labelled</th>
                                                        <th>Reviewed</th>
                                                        <th>Uploaded At</th>
                                                        <th>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for image in images %}
                                                    <tr>
                                                        <th style="text-align: center; vertical-align: top; width: 20px;">
                                                            <input class="checkbox select-row" data-rows-group-id="projects" type="checkbox" id="123" data-id="{{image.id}}" onclick="enableDisable()"/>
                                                        </th>
                                                        <td>{{ image.media_file.name|cut:'.jpeg'|cut:'.png'|cut:'.jpg' }}</td>
                                                        <td>{{ image.anotomy.name }}</td>
                                                        <td>{{ image.modality.name }}</td>
                                                        <td >
                                                            {% if image.anonymized == True %}
                                                                {% if image.anonymized %}
                                                                    <a href="{% url 'image-anonymized-view' image.id 'subject' %}" class="btn px-1 btn-success btn-sm text-white">Yes</a>
                                                                {% else %}
                                                                    <a disabled class="btn px-1 btn-success btn-sm text-white">Yes</a>
                                                                {% endif %}
                                                            {% elif image.anonymized == False %}
                                                                <a disabled class="btn px-1 btn-danger btn-sm text-white">No</a>
                                                            {% else %}
                                                                <a disabled class="btn px-1 btn-warning btn-sm text-white anonymized-in-progress" data-id="{{image.id}}">In Progress</a>
                                                            {% endif %}
                                                        </td>
                                                        {% if image.labelled %}
                                                            <td>
                                                                {% if image.labelled %}
                                                                    <a href="{% url 'image-labelled-view' image.id 'subject' %}" class="btn px-1 btn-success btn-sm text-white">Yes</a>
                                                                {% else %}
                                                                    <a disabled class="btn px-1 btn-success btn-sm text-white">Yes</a>
                                                                {% endif %}
                                                            </td>
                                                        {% else %}
                                                            <td>
                                                                <a disabled class="btn px-1 btn-danger btn-sm text-white">No</a>
                                                            </td>
                                                        {% endif %}
                                                        <td>
                                                            <a disabled class="btn px-1 btn-danger btn-sm text-white">No</a>
                                                        </td>
                                                        <td>{{ image.created_at }}</td>
                                                        <td>
                                                            <div class="fonticon-wrap">
                                                                {% if 'medical_research.download_image' in user.get_all_permissions %}
                                                                <a href="javascript:void(0);" class="btn px-1 btn-success btn-sm" data-toggle="modal" 
                                                                    onclick="download_img_id = {{image.id}}; console.log('image id: ', download_img_id);"
                                                                    data-target="#SingleDownloadModal">Download
                                                                </a>
                                                                {% endif %}
                                                                <a href="{% url 'image-view' image.id 'subject' %}" class="btn px-1 btn-primary btn-sm">Raw</a>
                                                                <a href="#" class="btn mr-1 btn-outline-danger btn-sm waves-effect waves-light" onclick='return confirmDelete("{% url 'image-delete' image.id %}");'><i class="feather icon-trash-2"></i>Delete</a>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                                <tfoot>
                                                    <tr>
                                                        <th></th>
                                                        <th>Name</th>
                                                        <th>Anatomy</th>
                                                        <th>Modality</th>
                                                        <th>Clean</th>
                                                        <th>Labelled</th>
                                                        <th>Reviewed</th>
                                                        <th>Uploaded At</th>
                                                        <th>Action</th>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% include 'includes/download_image.html' %}
                    <div class="modal fade" id="SingleDownloadModal" tabindex="-1" role="dialog" aria-labelledby="InsertModelTitle" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-dialog-centered modal-dialog-scrollable" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="InsertModelTitle">Download Images</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="form-body">
                                        <div class="row">
                                            <div class="col-12 d-flex">
                                                <input type="text" id="download_for" value="{{download_for}}" hidden>
                                                <button id="raw" class="btn btn-primary mr-1 mb-1" onclick="download_single_image(this);">Raw</button> 
                                                {% if image.anonymized%}
                                                    <button id="anonymized" class="btn btn-primary mr-1 mb-1" onclick="download_single_image(this);">Anonymized</button>
                                                {% else %}
                                                    <button id="anonymized" class="btn btn-primary mr-1 mb-1" disabled>Anonymized</button>
                                                {% endif %}
                                                {% if image.labelled %}
                                                    <button id="labelled" class="btn btn-primary mr-1 mb-1" onclick="download_single_image(this);">Labelled</button>
                                                {% else %}
                                                    <button id="labelled" class="btn btn-primary mr-1 mb-1" disabled>Labelled</button>
                                                {% endif %}
                                                <button id="all" class="btn btn-primary mr-1 mb-1" onclick="download_single_image(this);">All</button>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-3 d-flex">
                                                <span>Label Format:</span>
                                            </div>
                                            <div class="col-3 d-flex">
                                                <fieldset>
                                                    <div class="vs-radio-con vs-radio-primary">
                                                        <input type="radio" name="format_single" value="text" checked>
                                                        <span class="vs-radio vs-radio-sm">
                                                            <span class="vs-radio--border"></span>
                                                            <span class="vs-radio--circle"></span>
                                                        </span>
                                                        <span class="">Text</span>
                                                    </div>
                                                </fieldset>
                                            </div>
                                            <div class="col-3 d-flex">
                                                <fieldset>
                                                    <div class="vs-radio-con vs-radio-primary">
                                                        <input type="radio" name="format_single" value="csv">
                                                        <span class="vs-radio vs-radio-sm">
                                                            <span class="vs-radio--border"></span>
                                                            <span class="vs-radio--circle"></span>
                                                        </span>
                                                        <span class="">Csv</span>
                                                    </div>
                                                </fieldset>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" data-dismiss="modal">Accept</button>
                                </div> -->
                            </div>
                        </div>
                    </div>
                </section>
                <!--/ Zero configuration table -->
            </div>
        </div>
    <!-- END: Content-->
    <script src="https://appsrv1-147a1.kxcdn.com/django-datta-able-enh/js/plugins/sweetalert2.all.min.js" aria-hidden="true"></script>
    <script src="{% static 'js/scripts/google_drive.js' %}"></script>
    <script src="{% static 'js/scripts/anonymization.js' %}"></script>
    <script src="{% static 'js/scripts/diseases.js' %}"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script>
        var download_img_id = '';
        function download_single_image(obj){
            var id = download_img_id;
            var type = obj.getAttribute('id');
            var selectedIds = [id];
            var selectedFormat = document.querySelector('input[name="format_single"]:checked').value;
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/download/', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
            xhr.responseType = 'blob';
            xhr.onload = function() {
              if (this.status == 200) {
                var blob = this.response;
                var contentDisposition = xhr.getResponseHeader('Content-Disposition');
                var filename = contentDisposition.split(';')[1].split('=')[1].trim().replace(/"/g, '');
                var a = document.createElement('a');
                var url = window.URL.createObjectURL(blob);
                a.href = url;
                a.download = filename;
                a.click();
                window.URL.revokeObjectURL(url);
              }
            };
            xhr.send(JSON.stringify({ 'image_ids': selectedIds, 'type': type, 'format': selectedFormat, 'download_for': "{{download_for}}"}));
        }
    </script>    
    <script type="text/javascript">
        let uploadFromDrive = false;
        let csrf = "{{ csrf_token }}";
        let patient_id = '{{patient.id}}';
        
        function cancelRequest(){
            location.reload();
        }

        function onFormSubmit(event){
            event.preventDefault();
            if(uploadFromDrive){
                pickerSubmit();
            }else{
                uploadFiles(event);
            }
        }
        
        function uploadFiles(event) {
            const getFormDataSize = (formData) => [...formData].reduce((size, [name, value]) => size + (typeof value === 'string' ? value.length : value.size), 0);

            files = document.getElementById("media_files").files;
            if(files.length<=0){return false;}
            if(!validateAge()){ return false; }

            $("#submit_button").prop('disabled', true).text("Uploading");
            let uploadText = "Uploading";
            let dots = 0;
            const uploadInterval = setInterval(() => {
                dots = (dots + 1) % 4; // Cycle through 0, 1, 2, 3 dots
                const text = uploadText + ".".repeat(dots);
                $("#submit_button").text(text);
            }, 500); // Update text every 500 milliseconds

            $("#cancel_button").prop('disabled', false);
            var formData=new FormData();
            formData.append("csrfmiddlewaretoken",'{{ csrf_token }}');
            formData.append("patient_id", '{{patient.id}}');
            formData.append("anotomy_id",document.getElementById("anotomy").value);
            formData.append("modality_id",document.getElementById("modality").value);
            formData.append("age",document.getElementById("age").value);
            const selectedDiseases = $('#diseases').val();
            selectedDiseases.forEach(function(diseaseId, index) {
                formData.append('diseases[]', diseaseId);
            });

            var totalSize = getFormDataSize(formData);
            for (var x = 0; x < files.length; x++) {
                totalSize = totalSize + files[x].size;
            }
            console.log("TOTAL SIZE: ", totalSize);
            var temp = 0;
            var completed_req = 0
            var uploaded = 0;
            var indices = [...Array(files.length).keys()]
            const chunkSize = 5;

            for (let i = 0; i < indices.length; i += chunkSize) {
                const chunk = indices.slice(i, i + chunkSize);
                var flag = false;

                console.log("chunk size: ",chunk.length);
                for (var x = 0; x < chunk.length; x++) {
                    formData.append("media_files[]", files[chunk[x]]);
                }
                var xhr=new XMLHttpRequest();
                xhr.open("POST","/image_insert/",true);
                xhr.upload.addEventListener("progress",function (ev) {
                    if(ev.lengthComputable){
                        temp = uploaded + ev.loaded;
                        var percentage=(temp/totalSize*100|0);
                        document.getElementById("progress_bar_div").hidden = false;
                        document.getElementById("progress_bar").style["width"]=""+percentage+"%";
                        document.getElementById("progress_bar").innerHTML=""+percentage+"%";
                        console.log("Uploaded : "+temp);
                        console.log("TOTAL : "+totalSize);

                        if (ev.total==ev.loaded){
                            // console.log("                this is goodd");
                            // console.log("                ev. loaded", ev.loaded);
                            // console.log("                ev.  total", ev.total);
                            // console.log("                  uploaded", uploaded);
                            // console.log("                     total", totalSize);
                            uploaded = uploaded + ev.loaded;
                            completed_req = completed_req + 1
                            // console.log("                         this is goodd");
                            // console.log("                         ev. loaded", ev.loaded);
                            // console.log("                         ev.  total", ev.total);
                            // console.log("                           uploaded", uploaded);
                            // console.log("                              total", totalSize);
                        }
                    }
                });
                xhr.upload.onloadend = function (e) {
                    if((completed_req==indices.length) || (completed_req>(indices.length/chunkSize) && completed_req<((indices.length/chunkSize)+1))){
                        setTimeout(function(){
                            location.reload();
                        }, 3000);
                    }
                };
                xhr.onload = function () {window.location();}
                xhr.onerror = function () {window.location();}
                xhr.send(formData);
                formData.delete("media_files[]");
            }
        }
        
        $('#state').on('change', function(){
            var state = $(this).val();
            var hospital = $("#hospital")
            hospital.empty();
            $.ajax(
            {
                type:"GET",
                url: "/get_hospitals",
                data:{
                    'state': state,
                },
                success: function( data ) 
                {
                    hospitals = $.parseJSON(data).hospitals;
                    for (var i=0; i<hospitals.length; i++) {
                        hospital.append('<option value="' + hospitals[i] + '">' + hospitals[i] + '</option>');
                   }
                }
            })
        });

        $('input#media_files').change(function(){
            var files = $(this)[0].files;
            var button = $("#submit_button");
            if(files.length > 100){
                $("#no_of_files").text(`Number of files: ${files.length}`);
                $("#warning").text("Choose upto 100 files.");
                $("#submit_button").prop('disabled', true);
            }else{
                $("#warning").text("");
                $("#no_of_files").text(`Number of files: ${files.length}`);
                $("#submit_button").prop('disabled', false);
            }
        });

        function enableDisable() {
            var checkBox = document.querySelectorAll('input[id="123"]');
            var button = document.getElementById("clean_button")
            var delete_button = document.getElementById("delete_button");
            var download_button = document.getElementById("download_button");
            var selected_count = document.getElementById("selected_count");

            count = 0;
            for (i = 0; i < checkBox.length; ++i) {
                if(checkBox[i].checked == true){
                    count = count + 1;
                }
            }
            selected_count.innerHTML = `${count} Selected`;
            for (i = 0; i < checkBox.length; ++i) {
                if(checkBox[i].checked == true){
                    button.disabled = false;
                    delete_button.disabled = false;
                    download_button.disabled = false;
                    return;
                }
                console.log(checkBox[i].checked);
            }
            delete_button.disabled = true;
            button.disabled = true;
            download_button.disabled = true;
        }

        function selectAll(obj) {
            var checkBox = document.querySelectorAll('input[id="123"]');
            var button = document.getElementById("clean_button");
            var delete_button = document.getElementById("delete_button");
            var download_button = document.getElementById("download_button");
            if(obj.checked==true){
                selected_count.innerHTML = `${checkBox.length} Selected`;
            }
            else{
                selected_count.innerHTML = `0 Selected`;
            }
            for (i = 0; i < checkBox.length; ++i) {
                checkBox[i].checked = obj.checked;
                button.disabled = !obj.checked;
                delete_button.disabled = !obj.checked;
                download_button.disabled = !obj.checked;
            }
        }

        function clean_button() {
            var checkBox = document.querySelectorAll('input[id="123"]');
            var formData=new FormData();
            formData.append("csrfmiddlewaretoken",'{{ csrf_token }}');
            for (i = 0; i < checkBox.length; ++i) {
                if(checkBox[i].checked == true){
                    formData.append("ids[]", checkBox[i].getAttribute("data-id"));
                }
            }
            var xhr=new XMLHttpRequest();
            xhr.open("POST","/image_anonymize/",true);
            xhr.send(formData);
            location.reload();
        }

        function delete_button() {
            var checkBox = document.querySelectorAll('input[id="123"]');
            var formData=new FormData();
            formData.append("csrfmiddlewaretoken",'{{ csrf_token }}');
            for (i = 0; i < checkBox.length; ++i) {
                if(checkBox[i].checked == true){
                    formData.append("ids[]", checkBox[i].getAttribute("data-id"));
                }
            }
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    var xhr=new XMLHttpRequest();
                    xhr.open("POST","/image_bulk_destroy/",true);
                    xhr.onload = function () {location.reload();}
                    xhr.onerror = function () {location.reload();}
                    xhr.send(formData);
                }
            });
            return false;
        }

        function validateAge() {
            var ageType = document.getElementById('age_type').value;
            var age = document.getElementById('age').value;
            if (ageType == 'M') {
                if(age>=12){
                    $("#age-alert").text("less than 12");
                    $("#submit_button").prop('disabled', false);
                    return false;
                }
            }else{
                if(age>=150){
                    $("#age-alert").text("less than 150");
                    $("#submit_button").prop('disabled', false);
                    return false;
                }
            }
            return true;
        }
        function confirmDelete(url){
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = url;
                }
            });
            return false;
        }
        setInterval(getCleanStatus, 3000);
    </script>
{% endblock content %}
